<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Way Database Sync POC - Technical Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #2c3e50;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-left: 10px;
            border-left: 4px solid #3498db;
        }
        
        h3 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        h4 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .toc {
            background: #ecf0f1;
            padding: 20px;
            margin: 30px 0;
            border-radius: 5px;
        }
        
        .toc ul {
            list-style: none;
            padding-left: 20px;
        }
        
        .toc li {
            margin: 8px 0;
        }
        
        .toc a {
            color: #2980b9;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
        }
        
        .danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        .flow-diagram {
            background: #f8f9fa;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
        
        .component-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .component-box h4 {
            color: #2980b9;
            margin-top: 0;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 40px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .badge-success {
            background: #28a745;
            color: white;
        }
        
        .badge-warning {
            background: #ffc107;
            color: #333;
        }
        
        .badge-info {
            background: #17a2b8;
            color: white;
        }
        
        .print-hide {
            display: block;
        }
        
        @media print {
            .print-hide {
                display: none;
            }
            
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
            }
            
            pre {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Two-Way Database Synchronization POC</h1>
        <p><strong>Technical Documentation for Developers</strong></p>
        <p>Version: 1.0.0 | Date: January 2026</p>
        
        <div class="toc">
            <h3>ğŸ“‘ Table of Contents</h3>
            <ul>
                <li><a href="#executive-summary">1. Executive Summary</a></li>
                <li><a href="#architecture">2. System Architecture</a></li>
                <li><a href="#components">3. Core Components</a></li>
                <li><a href="#data-flow">4. Data Flow & Processing</a></li>
                <li><a href="#function-details">5. Function-Level Details</a></li>
                <li><a href="#configuration">6. Configuration Guide</a></li>
                <li><a href="#production">7. Production Deployment</a></li>
                <li><a href="#monitoring">8. Monitoring & Troubleshooting</a></li>
            </ul>
        </div>

        <!-- SECTION 1: EXECUTIVE SUMMARY -->
        <h2 id="executive-summary">1. Executive Summary</h2>
        
        <h3>1.1 What Was Built</h3>
        <p>A <strong>two-way database synchronization system</strong> that keeps a Legacy (PostgreSQL) and Revamped (MySQL) platform in sync in real-time using <strong>Change Data Capture (CDC)</strong>, <strong>Apache Kafka</strong>, and a custom <strong>Laravel-based Sync Service</strong>.</p>
        
        <div class="success">
            <strong>âœ… Capabilities:</strong>
            <ul>
                <li><strong>Bidirectional Sync:</strong> Changes in either database automatically replicate to the other</li>
                <li><strong>Real-Time:</strong> Sub-second latency using CDC and Kafka</li>
                <li><strong>Loop Prevention:</strong> Intelligent source tracking prevents infinite sync loops</li>
                <li><strong>Schema Transformation:</strong> Automatic mapping between different database schemas</li>
                <li><strong>Idempotency:</strong> Safe replaying of events without duplicates</li>
                <li><strong>Fault Tolerance:</strong> Retry logic, error handling, and Dead Letter Queue (DLQ)</li>
            </ul>
        </div>

        <h3>1.2 Loop Prevention: What's Required vs. Optional</h3>
        <div class="info">
            <p><strong>Key Question:</strong> "Do I need <code>source='legacy'</code> or <code>source='revamp'</code> on every record?"</p>
            <p><strong>Answer:</strong> <strong>No, not strictly required.</strong> You only need to mark synced records.</p>
        </div>

        <table>
            <tr>
                <th>Requirement</th>
                <th>Status</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td><code>source='sync_service'</code> on synced records</td>
                <td><span class="badge badge-success">REQUIRED</span></td>
                <td>Loop prevention (critical!)</td>
            </tr>
            <tr>
                <td><code>source='legacy'</code> or <code>'postgres'</code> on PostgreSQL records</td>
                <td><span class="badge badge-info">OPTIONAL</span></td>
                <td>Data provenance tracking (nice to have)</td>
            </tr>
            <tr>
                <td><code>source='revamp'</code> or <code>'mysql'</code> on MySQL records</td>
                <td><span class="badge badge-info">OPTIONAL</span></td>
                <td>Data provenance tracking (nice to have)</td>
            </tr>
        </table>

        <p><strong>Minimum Working Configuration:</strong></p>
        <ul>
            <li>Original records: <code>source = NULL</code> (or any value except <code>'sync_service'</code>)</li>
            <li>Synced records: <code>source = 'sync_service'</code> (set by sync service)</li>
            <li>Loop prevention: <code>if (source === 'sync_service') skip();</code></li>
        </ul>

        <p><strong>Recommended Configuration:</strong></p>
        <ul>
            <li>PostgreSQL records: <code>source = 'postgres'</code> or <code>'legacy'</code></li>
            <li>MySQL records: <code>source = 'mysql'</code> or <code>'revamp'</code></li>
            <li>Synced records: <code>source = 'sync_service'</code></li>
            <li>âœ… Provides data provenance + loop prevention</li>
        </ul>

        <h3>1.3 Technology Stack</h3>
        <table>
            <tr>
                <th>Component</th>
                <th>Technology</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td>Legacy Database</td>
                <td>PostgreSQL 15</td>
                <td>Source/Target database for legacy platform</td>
            </tr>
            <tr>
                <td>Revamped Database</td>
                <td>MySQL 8</td>
                <td>Source/Target database for new platform</td>
            </tr>
            <tr>
                <td>CDC Tool</td>
                <td>Debezium 2.4</td>
                <td>Captures database changes in real-time</td>
            </tr>
            <tr>
                <td>Message Broker</td>
                <td>Apache Kafka 3.6</td>
                <td>Event streaming and message transport</td>
            </tr>
            <tr>
                <td>Sync Service</td>
                <td>Laravel 10 (PHP 8.1)</td>
                <td>Consumes events, transforms data, writes to target DB</td>
            </tr>
            <tr>
                <td>Kafka Consumer</td>
                <td>librdkafka (PHP extension)</td>
                <td>High-performance Kafka message consumption</td>
            </tr>
        </table>

        <!-- SECTION 2: ARCHITECTURE -->
        <h2 id="architecture">2. System Architecture</h2>

        <h3>2.1 High-Level Architecture</h3>
        <div class="flow-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚                                      â”‚      MySQL      â”‚
â”‚  (Legacy DB)    â”‚                                      â”‚  (Revamped DB)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                        â”‚
         â”‚ Debezium CDC                                 Debezium CDC â”‚
         â”‚ (pgoutput)                                   (binlog)     â”‚
         â–¼                                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Debezium      â”‚                                      â”‚   Debezium      â”‚
â”‚   Connector     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”‚   Connector     â”‚
â”‚  (PostgreSQL)   â”‚        â”‚                    â”‚        â”‚    (MySQL)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                    â”‚
                           â–¼                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Apache Kafka            â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚   â”‚  Topics:            â”‚    â”‚
                    â”‚   â”‚  - legacy.public.*  â”‚    â”‚
                    â”‚   â”‚  - revamp.revamp_db.*â”‚   â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ Consume Events
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Laravel Sync Service       â”‚
                    â”‚                              â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ Legacy Event Consumer  â”‚  â”‚
                    â”‚  â”‚  (PGâ†’MySQL)           â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                              â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ Revamp Event Consumer  â”‚  â”‚
                    â”‚  â”‚  (MySQLâ†’PG)           â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                              â”‚
                    â”‚  â”œâ”€ DTOs (Data Objects)     â”‚
                    â”‚  â”œâ”€ Transformers (Schema)   â”‚
                    â”‚  â”œâ”€ Writers (Idempotent)    â”‚
                    â”‚  â””â”€ Error Handlers          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â–¼                         â–¼
        Write to MySQL              Write to PostgreSQL
        (with source='sync_service')
        </div>

        <h3>2.2 Data Flow: PostgreSQL â†’ MySQL</h3>
        <ol>
            <li><strong>Insert/Update/Delete</strong> occurs in PostgreSQL <code>legacy_users</code> table with <code>source='legacy'</code></li>
            <li><strong>Debezium PostgreSQL Connector</strong> captures the change via pgoutput protocol</li>
            <li>Change is published to Kafka topic: <code>legacy.public.legacy_users</code></li>
            <li><strong>Legacy Event Consumer</strong> (Laravel) consumes the event from Kafka</li>
            <li><strong>Loop Check:</strong> If <code>source='sync_service'</code>, skip (prevent loop)</li>
            <li><strong>Transform:</strong> Convert PostgreSQL schema to MySQL schema using <code>LegacyToRevampMapper</code></li>
            <li><strong>Write:</strong> UPSERT to MySQL <code>revamp_users</code> table with <code>source='sync_service'</code></li>
            <li><strong>Commit:</strong> Mark Kafka offset as processed</li>
        </ol>

        <h3>2.3 Data Flow: MySQL â†’ PostgreSQL</h3>
        <ol>
            <li><strong>Insert/Update/Delete</strong> occurs in MySQL <code>revamp_users</code> table with <code>source='revamp'</code></li>
            <li><strong>Debezium MySQL Connector</strong> captures the change via binlog</li>
            <li>Change is published to Kafka topic: <code>revamp.revamp_db.revamp_users</code></li>
            <li><strong>Revamp Event Consumer</strong> (Laravel) consumes the event from Kafka</li>
            <li><strong>Loop Check:</strong> If <code>source='sync_service'</code>, skip (prevent loop)</li>
            <li><strong>Transform:</strong> Convert MySQL schema to PostgreSQL schema using <code>RevampToLegacyMapper</code></li>
            <li><strong>Write:</strong> UPSERT to PostgreSQL <code>legacy_users</code> table with <code>source='sync_service'</code></li>
            <li><strong>Commit:</strong> Mark Kafka offset as processed</li>
        </ol>

        <div class="info">
            <strong>ğŸ”‘ Key Concept: Loop Prevention</strong><br>
            The <code>source</code> column tracks the origin of each record:
            <ul>
                <li><code>source='legacy'</code> â†’ Original record from PostgreSQL (for data provenance tracking)</li>
                <li><code>source='revamp'</code> â†’ Original record from MySQL (for data provenance tracking)</li>
                <li><code>source='sync_service'</code> â†’ Synced record (REQUIRED - DO NOT sync back)</li>
            </ul>
            When a consumer sees <code>source='sync_service'</code>, it skips processing to prevent infinite loops.
            <br><br>
            <strong>ğŸ“ Note:</strong> Only <code>source='sync_service'</code> is strictly required for loop prevention. 
            The three-value approach (<code>legacy</code>, <code>revamp</code>, <code>sync_service</code>) is used for data provenance tracking,
            allowing you to identify where each record originated. A simpler two-value approach (<code>NULL</code> or <code>'original'</code> for 
            native records, <code>'sync_service'</code> for synced records) would also work, but you'd lose origin tracking.
        </div>

        <!-- SECTION 3: CORE COMPONENTS -->
        <h2 id="components">3. Core Components</h2>

        <h3>3.1 Debezium Connectors</h3>
        
        <div class="component-box">
            <h4>PostgreSQL Connector</h4>
            <p><strong>File:</strong> <code>debezium/postgres-connector.json</code></p>
            <p><strong>Purpose:</strong> Monitors PostgreSQL write-ahead log (WAL) for changes</p>
            <p><strong>Key Configuration:</strong></p>
            <pre><code>{
  "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
  "plugin.name": "pgoutput",
  "table.include.list": "public.legacy_users,public.legacy_posts,public.legacy_likes",
  "transforms": "unwrap",
  "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState"
}</code></pre>
            <p><strong>Output Topics:</strong></p>
            <ul>
                <li><code>legacy.public.legacy_users</code></li>
                <li><code>legacy.public.legacy_posts</code></li>
                <li><code>legacy.public.legacy_likes</code></li>
            </ul>
        </div>

        <div class="component-box">
            <h4>MySQL Connector</h4>
            <p><strong>File:</strong> <code>debezium/mysql-connector.json</code></p>
            <p><strong>Purpose:</strong> Monitors MySQL binlog for changes</p>
            <p><strong>Key Configuration:</strong></p>
            <pre><code>{
  "connector.class": "io.debezium.connector.mysql.MySqlConnector",
  "table.include.list": "revamp_db.revamp_users,revamp_db.revamp_posts,revamp_db.revamp_likes",
  "schema.history.internal.kafka.bootstrap.servers": "kafka:9092",
  "schema.history.internal.kafka.topic": "schema-changes.revamp"
}</code></pre>
            <p><strong>Output Topics:</strong></p>
            <ul>
                <li><code>revamp.revamp_db.revamp_users</code></li>
                <li><code>revamp.revamp_db.revamp_posts</code></li>
                <li><code>revamp.revamp_db.revamp_likes</code></li>
            </ul>
        </div>

        <div class="warning">
            <strong>âš ï¸ Important:</strong> The <code>ExtractNewRecordState</code> transform flattens Debezium's envelope format. Messages arrive as:
            <pre><code>{"id": 1, "username": "john", ...}</code></pre>
            Instead of:
            <pre><code>{"after": {"id": 1, "username": "john", ...}, "before": {...}, "op": "c"}</code></pre>
        </div>

        <h3>3.2 Laravel Sync Service</h3>

        <h4>3.2.1 Consumers</h4>
        <p>Two independent consumers run as long-running PHP processes:</p>

        <div class="component-box">
            <h4>Legacy Event Consumer</h4>
            <p><strong>File:</strong> <code>app/Services/Consumers/LegacyEventConsumer.php</code></p>
            <p><strong>Purpose:</strong> Consume events from PostgreSQL topics and sync to MySQL</p>
            <p><strong>Consumer Group:</strong> <code>sync-service-legacy</code></p>
            <p><strong>Topics Subscribed:</strong></p>
            <ul>
                <li><code>legacy.public.legacy_users</code></li>
                <li><code>legacy.public.legacy_posts</code></li>
                <li><code>legacy.public.legacy_likes</code></li>
            </ul>
            <p><strong>Command:</strong> <code>php artisan consume:legacy-events</code></p>
        </div>

        <div class="component-box">
            <h4>Revamp Event Consumer</h4>
            <p><strong>File:</strong> <code>app/Services/Consumers/RevampEventConsumer.php</code></p>
            <p><strong>Purpose:</strong> Consume events from MySQL topics and sync to PostgreSQL</p>
            <p><strong>Consumer Group:</strong> <code>sync-service-revamp</code></p>
            <p><strong>Topics Subscribed:</strong></p>
            <ul>
                <li><code>revamp.revamp_db.revamp_users</code></li>
                <li><code>revamp.revamp_db.revamp_posts</code></li>
                <li><code>revamp.revamp_db.revamp_likes</code></li>
            </ul>
            <p><strong>Command:</strong> <code>php artisan consume:revamp-events</code></p>
        </div>

        <h4>3.2.2 DTOs (Data Transfer Objects)</h4>
        <p><strong>Directory:</strong> <code>app/DTOs/</code></p>
        <p>Platform-agnostic representations of entities:</p>
        
        <table>
            <tr>
                <th>DTO</th>
                <th>Purpose</th>
                <th>Methods</th>
            </tr>
            <tr>
                <td><code>SyncEvent</code></td>
                <td>Wrapper for all CDC events</td>
                <td><code>fromDebeziumEvent()</code>, <code>shouldSkip()</code></td>
            </tr>
            <tr>
                <td><code>UserDTO</code></td>
                <td>Represents a User entity</td>
                <td><code>fromLegacy()</code>, <code>fromRevamp()</code>, <code>toLegacy()</code>, <code>toRevamp()</code></td>
            </tr>
            <tr>
                <td><code>PostDTO</code></td>
                <td>Represents a Post entity</td>
                <td>Same as UserDTO</td>
            </tr>
            <tr>
                <td><code>LikeDTO</code></td>
                <td>Represents a Like entity</td>
                <td>Same as UserDTO</td>
            </tr>
        </table>

        <h4>3.2.3 Transformers</h4>
        <p><strong>Directory:</strong> <code>app/Services/Transformers/</code></p>
        <p>Handle schema differences between platforms:</p>

        <div class="component-box">
            <h4>LegacyToRevampMapper</h4>
            <p><strong>File:</strong> <code>app/Services/Transformers/LegacyToRevampMapper.php</code></p>
            <p><strong>Purpose:</strong> Transform PostgreSQL schema to MySQL schema</p>
            <p><strong>Example Mapping:</strong></p>
            <table>
                <tr>
                    <th>PostgreSQL (Legacy)</th>
                    <th>MySQL (Revamp)</th>
                </tr>
                <tr>
                    <td><code>username</code></td>
                    <td><code>user_name</code></td>
                </tr>
                <tr>
                    <td><code>email</code></td>
                    <td><code>email_address</code></td>
                </tr>
                <tr>
                    <td><code>full_name</code></td>
                    <td><code>display_name</code></td>
                </tr>
                <tr>
                    <td><code>phone_number</code></td>
                    <td><code>mobile</code></td>
                </tr>
                <tr>
                    <td><code>status</code></td>
                    <td><code>account_status</code></td>
                </tr>
            </table>
        </div>

        <div class="component-box">
            <h4>RevampToLegacyMapper</h4>
            <p><strong>File:</strong> <code>app/Services/Transformers/RevampToLegacyMapper.php</code></p>
            <p><strong>Purpose:</strong> Transform MySQL schema to PostgreSQL schema (reverse of above)</p>
        </div>

        <h4>3.2.4 Writers (Idempotent)</h4>
        <p><strong>Directory:</strong> <code>app/Services/Writers/</code></p>

        <div class="component-box">
            <h4>IdempotentRevampWriter</h4>
            <p><strong>File:</strong> <code>app/Services/Writers/IdempotentRevampWriter.php</code></p>
            <p><strong>Purpose:</strong> Write to MySQL with UPSERT (INSERT ... ON DUPLICATE KEY UPDATE)</p>
            <p><strong>Key Feature:</strong> Sets <code>source='sync_service'</code> on all writes</p>
        </div>

        <div class="component-box">
            <h4>IdempotentLegacyWriter</h4>
            <p><strong>File:</strong> <code>app/Services/Writers/IdempotentLegacyWriter.php</code></p>
            <p><strong>Purpose:</strong> Write to PostgreSQL with UPSERT (INSERT ... ON CONFLICT DO UPDATE)</p>
            <p><strong>Key Feature:</strong> Sets <code>source='sync_service'</code> on all writes</p>
        </div>

        <div class="info">
            <strong>ğŸ’¡ Idempotency:</strong> Both writers use UPSERT operations, meaning:
            <ul>
                <li>If record doesn't exist â†’ INSERT</li>
                <li>If record exists â†’ UPDATE</li>
                <li>Same event processed multiple times â†’ Same result (no duplicates)</li>
            </ul>
        </div>

        <h4>3.2.5 Error Handlers</h4>
        <p><strong>Directory:</strong> <code>app/Services/Handlers/</code></p>

        <table>
            <tr>
                <th>Handler</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td><code>RetryHandler</code></td>
                <td>Retry failed operations with exponential backoff (max 3 attempts)</td>
            </tr>
            <tr>
                <td><code>ErrorHandler</code></td>
                <td>Log errors, track metrics</td>
            </tr>
            <tr>
                <td><code>DLQHandler</code></td>
                <td>Send failed events to Dead Letter Queue (<code>sync.dlq</code> topic)</td>
            </tr>
        </table>

        <!-- SECTION 4: DATA FLOW -->
        <h2 id="data-flow">4. Data Flow & Processing</h2>

        <h3>4.1 Complete Flow: PostgreSQL â†’ MySQL</h3>
        <div class="flow-diagram">
1. User action in PostgreSQL:
   INSERT INTO legacy_users (username, email, full_name, source) 
   VALUES ('john', 'john@test.com', 'John Doe', 'legacy');

2. Debezium PostgreSQL Connector captures change

3. Event published to Kafka:
   Topic: legacy.public.legacy_users
   Message: {
     "id": 123,
     "username": "john",
     "email": "john@test.com",
     "full_name": "John Doe",
     "phone_number": "+1234567890",
     "status": "active",
     "source": "legacy",
     "__op": "c",
     "__deleted": "false"
   }

4. Legacy Event Consumer receives message

5. Parse into SyncEvent DTO:
   SyncEvent {
     eventId: "uuid",
     entityType: "users",
     operation: "CREATE",
     primaryKey: 123,
     payload: {...},
     source: "legacy"
   }

6. Loop Prevention Check:
   if (event.source === 'sync_service') { skip(); }
   // Passes: source is 'legacy'

7. Transform using LegacyToRevampMapper:
   UserDTO -> toLegacy() -> {
     "id": 123,
     "user_name": "john",
     "email_address": "john@test.com",
     "display_name": "John Doe",
     "mobile": "+1234567890",
     "account_status": "Active",
     "source": "sync_service"  // â† Changed!
   }

8. Write to MySQL using IdempotentRevampWriter:
   INSERT INTO revamp_users (...) VALUES (...)
   ON DUPLICATE KEY UPDATE ...;

9. Commit Kafka offset

10. Result in MySQL:
    id  | user_name | email_address    | source
    123 | john      | john@test.com    | sync_service
        </div>

        <h3>4.2 Loop Prevention in Action</h3>
        <p>When the synced record in MySQL is updated:</p>
        <div class="flow-diagram">
1. Update occurs in MySQL:
   UPDATE revamp_users SET display_name = 'John Updated'
   WHERE id = 123;

2. Debezium MySQL Connector captures change

3. Event published to Kafka:
   Topic: revamp.revamp_db.revamp_users
   Message: {
     "id": 123,
     "user_name": "john",
     "display_name": "John Updated",
     "source": "sync_service",  // â† Note: sync_service
     "__op": "u"
   }

4. Revamp Event Consumer receives message

5. Parse into SyncEvent

6. Loop Prevention Check:
   if (event.source === 'sync_service') { 
     Log: "Skipping event (loop prevention)"
     return; // â† STOPS HERE
   }

7. Event is NOT processed
   âœ… No sync back to PostgreSQL
   âœ… No infinite loop
        </div>

        <h3>4.3 Source Column Values: Complete Example</h3>
        <p>Here's how the <code>source</code> column works across both databases:</p>

        <table>
            <tr>
                <th>Scenario</th>
                <th>PostgreSQL <code>source</code></th>
                <th>MySQL <code>source</code></th>
                <th>Action</th>
            </tr>
            <tr>
                <td><strong>User created in PostgreSQL</strong></td>
                <td><code>'legacy'</code> or <code>'postgres'</code></td>
                <td><code>'sync_service'</code> (after sync)</td>
                <td>âœ… Synced to MySQL</td>
            </tr>
            <tr>
                <td><strong>User created in MySQL</strong></td>
                <td><code>'sync_service'</code> (after sync)</td>
                <td><code>'revamp'</code> or <code>'mysql'</code></td>
                <td>âœ… Synced to PostgreSQL</td>
            </tr>
            <tr>
                <td><strong>Synced user updated in PostgreSQL</strong></td>
                <td><code>'sync_service'</code></td>
                <td>-</td>
                <td>âŒ Skipped (loop prevention)</td>
            </tr>
            <tr>
                <td><strong>Synced user updated in MySQL</strong></td>
                <td>-</td>
                <td><code>'sync_service'</code></td>
                <td>âŒ Skipped (loop prevention)</td>
            </tr>
            <tr>
                <td><strong>Original user updated in PostgreSQL</strong></td>
                <td><code>'legacy'</code> or <code>'postgres'</code></td>
                <td><code>'sync_service'</code> (updated)</td>
                <td>âœ… Synced to MySQL</td>
            </tr>
            <tr>
                <td><strong>Original user updated in MySQL</strong></td>
                <td><code>'sync_service'</code> (updated)</td>
                <td><code>'revamp'</code> or <code>'mysql'</code></td>
                <td>âœ… Synced to PostgreSQL</td>
            </tr>
        </table>

        <div class="warning">
            <strong>âš ï¸ Critical Rule:</strong> The sync service <strong>always</strong> sets <code>source='sync_service'</code> when writing to the target database.
            This ensures the synced record won't be synced back, preventing loops.
        </div>

        <h4>Visual Example: Full Lifecycle</h4>
        <div class="flow-diagram">
TIME 0: User created in PostgreSQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL: legacy_users         â”‚
â”‚ id: 123                          â”‚
â”‚ username: john                   â”‚
â”‚ source: 'legacy' â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DEFAULT VALUE (native record)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Debezium captures change
        â”‚ Kafka: legacy.public.legacy_users
        â”‚ Consumer processes event
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQL: revamp_users              â”‚
â”‚ id: 123                          â”‚
â”‚ user_name: john                  â”‚
â”‚ source: 'sync_service' â†â”€â”€â”€â”€â”€â”€â”€â”€â”€ SET BY SYNC SERVICE (synced record)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Debezium captures this INSERT too!
        â”‚ Kafka: revamp.revamp_db.revamp_users
        â”‚ Consumer receives event
        â”‚
        â–¼
    Loop Check: source='sync_service'?
        â”‚
        â””â”€â”€> YES! Skip processing âœ…
             No sync back to PostgreSQL
             Loop prevented!


TIME 1: Original user updated in PostgreSQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL: legacy_users         â”‚
â”‚ id: 123                          â”‚
â”‚ username: john                   â”‚
â”‚ email: newemail@test.com â†â”€â”€â”€â”€â”€â”€ UPDATED
â”‚ source: 'legacy' â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STILL 'legacy' (native)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Debezium captures UPDATE
        â”‚ Consumer processes (source='legacy', not 'sync_service')
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQL: revamp_users              â”‚
â”‚ id: 123                          â”‚
â”‚ user_name: john                  â”‚
â”‚ email_address: newemail@test.com â”‚
â”‚ source: 'sync_service' â†â”€â”€â”€â”€â”€â”€â”€â”€â”€ REMAINS 'sync_service'
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Debezium captures UPDATE
        â”‚ Loop check: source='sync_service'? YES!
        â”‚
        â””â”€â”€> Skip âœ… No loop


TIME 2: Someone manually updates synced record in MySQL (shouldn't happen, but if it does)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQL: revamp_users              â”‚
â”‚ id: 123                          â”‚
â”‚ display_name: 'MANUAL EDIT' â†â”€â”€â”€ UPDATED
â”‚ source: 'sync_service' â†â”€â”€â”€â”€â”€â”€â”€â”€â”€ STILL 'sync_service'
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Debezium captures UPDATE
        â”‚ Loop check: source='sync_service'? YES!
        â”‚
        â””â”€â”€> Skip âœ… No loop
             (BUT: this edit won't sync to PostgreSQL)
             (Data drift may occur - monitor for this!)
        </div>

        <div class="info">
            <strong>ğŸ’¡ Key Insight:</strong> The <code>source</code> value is <strong>permanent</strong> for each record.
            <ul>
                <li>Records created in PostgreSQL always have <code>source='legacy'</code> in PostgreSQL</li>
                <li>When synced to MySQL, they get <code>source='sync_service'</code> in MySQL</li>
                <li>Updates to the original record continue to sync (because source='legacy' in origin DB)</li>
                <li>Updates to the synced copy do NOT sync back (because source='sync_service')</li>
            </ul>
        </div>

        <!-- SECTION 5: FUNCTION-LEVEL DETAILS -->
        <h2 id="function-details">5. Function-Level Details</h2>

        <h3>5.1 BaseConsumer Class</h3>
        <p><strong>File:</strong> <code>app/Services/Consumers/BaseConsumer.php</code></p>
        <p><strong>Purpose:</strong> Abstract base class for all Kafka consumers</p>

        <h4>Key Methods:</h4>

        <div class="component-box">
            <h4><code>consume(): void</code></h4>
            <p><strong>Purpose:</strong> Main event loop - subscribes to topics and continuously polls for messages</p>
            <pre><code>public function consume(): void
{
    $this->setupSignalHandlers();
    $this->consumer->subscribe($this->getTopics());
    
    while ($this->running) {
        $this->consumeMessage();  // Poll and process
    }
}</code></pre>
        </div>

        <div class="component-box">
            <h4><code>handleMessage(Message $message): void</code></h4>
            <p><strong>Purpose:</strong> Process a single Kafka message</p>
            <p><strong>Steps:</strong></p>
            <ol>
                <li>Parse JSON payload</li>
                <li>Create <code>SyncEvent</code> from Debezium message</li>
                <li>Check loop prevention (<code>shouldSkip()</code>)</li>
                <li>Check idempotency (<code>isAlreadyProcessed()</code>)</li>
                <li>Call <code>processEvent()</code> (implemented by subclass)</li>
                <li>Track processed event</li>
                <li>Commit offset</li>
            </ol>
        </div>

        <div class="component-box">
            <h4><code>isAlreadyProcessed(SyncEvent $event): bool</code></h4>
            <p><strong>Purpose:</strong> Check if event was already processed (idempotency)</p>
            <p><strong>Implementation:</strong></p>
            <pre><code>protected function isAlreadyProcessed(SyncEvent $event): bool
{
    return ProcessedEvent::where('event_id', $event->eventId)
        ->where('entity_type', $event->entityType)
        ->where('primary_key', $event->primaryKey)
        ->exists();
}</code></pre>
        </div>

        <h3>5.2 SyncEvent DTO</h3>
        <p><strong>File:</strong> <code>app/DTOs/SyncEvent.php</code></p>

        <div class="component-box">
            <h4><code>fromDebeziumEvent(array $message, string $topic): self</code></h4>
            <p><strong>Purpose:</strong> Parse Debezium CDC message into SyncEvent</p>
            <p><strong>Key Logic:</strong></p>
            <pre><code>public static function fromDebeziumEvent(array $message, string $topic): self
{
    // Extract table name from topic
    // Topic: legacy.public.legacy_users â†’ Entity: users
    $tableName = end(explode('.', $topic));
    $entityType = preg_replace('/^(legacy_|revamp_)/', '', $tableName);
    
    // Map Debezium operation codes
    $operation = match($message['__op'] ?? 'r') {
        'c', 'r' => 'CREATE',  // c=create, r=read (snapshot)
        'u' => 'UPDATE',
        'd' => 'DELETE',
    };
    
    // Handle unwrapped format (ExtractNewRecordState transform)
    if (isset($message['after']) || isset($message['before'])) {
        // Standard envelope format
        $payload = match($operation) {
            'DELETE' => $message['before'] ?? [],
            default => $message['after'] ?? $message['before'] ?? [],
        };
    } else {
        // Flattened format (our case)
        $payload = $message;
    }
    
    return new self(
        eventId: Uuid::uuid4()->toString(),
        entityType: $entityType,
        operation: $operation,
        primaryKey: $payload['id'],
        payload: $payload,
        source: $payload['source'] ?? 'legacy',
        ...
    );
}</code></pre>
        </div>

        <div class="component-box">
            <h4><code>shouldSkip(): bool</code></h4>
            <p><strong>Purpose:</strong> Loop prevention check</p>
            <pre><code>public function shouldSkip(): bool
{
    // Skip events from sync service to prevent infinite loops
    return $this->source === self::SOURCE_SYNC_SERVICE;
}</code></pre>
        </div>

        <h3>5.3 UserDTO Transformation</h3>
        <p><strong>File:</strong> <code>app/DTOs/UserDTO.php</code></p>

        <div class="component-box">
            <h4><code>fromLegacy(array $data): self</code></h4>
            <p><strong>Purpose:</strong> Parse PostgreSQL user data into DTO</p>
            <pre><code>public static function fromLegacy(array $data): self
{
    return new self(
        id: $data['id'],
        username: $data['username'],
        email: $data['email'],
        displayName: $data['full_name'] ?? null,
        phone: $data['phone_number'] ?? null,
        status: strtolower($data['status'] ?? 'active'),
        createdAt: $data['created_at'] ?? null,
        updatedAt: $data['updated_at'] ?? null,
    );
}</code></pre>
        </div>

        <div class="component-box">
            <h4><code>toRevamp(): array</code></h4>
            <p><strong>Purpose:</strong> Convert DTO to MySQL format</p>
            <pre><code>public function toRevamp(): array
{
    return [
        'id' => $this->id,
        'user_name' => $this->username,
        'email_address' => $this->email,
        'display_name' => $this->displayName,
        'mobile' => $this->phone,
        'account_status' => ucfirst($this->status),
        'source' => 'sync_service',  // â† Always set to sync_service
    ];
}</code></pre>
        </div>

        <h3>5.4 Idempotent Writers</h3>

        <div class="component-box">
            <h4><code>IdempotentRevampWriter::write()</code></h4>
            <p><strong>File:</strong> <code>app/Services/Writers/IdempotentRevampWriter.php</code></p>
            <p><strong>Purpose:</strong> Write to MySQL with UPSERT</p>
            <pre><code>public function write(string $entityType, array $data, SyncEvent $event): bool
{
    DB::connection('revamp')->beginTransaction();
    
    $tableName = $this->getTableName($entityType);
    
    if ($event->isDelete()) {
        // Handle DELETE
        DB::connection('revamp')
            ->table($tableName)
            ->where('id', $data['id'])
            ->delete();
    } else {
        // Handle CREATE/UPDATE with UPSERT
        $columns = array_keys($data);
        $values = array_values($data);
        
        $updateSet = array_map(
            fn($col) => "`{$col}` = VALUES(`{$col}`)",
            array_filter($columns, fn($col) => $col !== 'id')
        );
        
        $sql = sprintf(
            "INSERT INTO %s (%s) VALUES (%s) ON DUPLICATE KEY UPDATE %s",
            $tableName,
            implode(', ', array_map(fn($c) => "`{$c}`", $columns)),
            implode(', ', array_fill(0, count($values), '?')),
            implode(', ', $updateSet)
        );
        
        DB::connection('revamp')->insert($sql, $values);
    }
    
    // Track entity mapping for bidirectional sync
    $this->trackEntityMapping($event, $data['id']);
    
    DB::connection('revamp')->commit();
    return true;
}</code></pre>
        </div>

        <div class="component-box">
            <h4><code>IdempotentLegacyWriter::write()</code></h4>
            <p><strong>File:</strong> <code>app/Services/Writers/IdempotentLegacyWriter.php</code></p>
            <p><strong>Purpose:</strong> Write to PostgreSQL with UPSERT</p>
            <p><strong>Key Difference:</strong> PostgreSQL uses <code>ON CONFLICT ... DO UPDATE</code> syntax</p>
            <pre><code>$sql = sprintf(
    "INSERT INTO %s (%s) VALUES (%s) ON CONFLICT (id) DO UPDATE SET %s, updated_at = CURRENT_TIMESTAMP",
    $tableName,
    implode(', ', $columns),
    implode(', ', array_fill(0, count($values), '?')),  // â† Use ? not $1, $2
    implode(', ', $updateSet)
);

DB::connection('legacy')->insert($sql, $values);</code></pre>
            <p><strong>Critical Fix:</strong> Use <code>?</code> placeholders (not <code>$1, $2, $3</code>) for Laravel compatibility</p>
        </div>

        <!-- SECTION 6: CONFIGURATION -->
        <h2 id="configuration">6. Configuration Guide</h2>

        <h3>6.1 Environment Variables</h3>
        <p><strong>File:</strong> <code>sync-service/.env</code></p>

        <h4>Database Connections:</h4>
        <pre><code># Legacy PostgreSQL Database
DB_LEGACY_CONNECTION=pgsql
DB_LEGACY_HOST=127.0.0.1
DB_LEGACY_PORT=5433          # Changed from 5432 due to local conflict
DB_LEGACY_DATABASE=legacy_db
DB_LEGACY_USERNAME=postgres
DB_LEGACY_PASSWORD=postgres

# Revamped MySQL Database
DB_REVAMP_CONNECTION=mysql
DB_REVAMP_HOST=127.0.0.1
DB_REVAMP_PORT=3306
DB_REVAMP_DATABASE=revamp_db
DB_REVAMP_USERNAME=root
DB_REVAMP_PASSWORD=root</code></pre>

        <h4>Kafka Configuration:</h4>
        <pre><code>KAFKA_BROKERS=localhost:29092
KAFKA_CONSUMER_GROUP_ID=sync-service

# Legacy Topics (PostgreSQL)
KAFKA_LEGACY_TOPIC=legacy.public.legacy_users,legacy.public.legacy_posts,legacy.public.legacy_likes
KAFKA_LEGACY_CONSUMER_GROUP=sync-service-legacy

# Revamp Topics (MySQL)
KAFKA_REVAMP_TOPIC=revamp.revamp_db.revamp_users,revamp.revamp_db.revamp_posts,revamp.revamp_db.revamp_likes
KAFKA_REVAMP_CONSUMER_GROUP=sync-service-revamp

# DLQ Topic
KAFKA_DLQ_TOPIC=sync.dlq

# Consumer Settings
KAFKA_AUTO_OFFSET_RESET=earliest
KAFKA_ENABLE_AUTO_COMMIT=false
KAFKA_SESSION_TIMEOUT_MS=30000
KAFKA_MAX_POLL_RECORDS=100</code></pre>

        <h3>6.2 Debezium Connector Configuration</h3>

        <h4>PostgreSQL Connector:</h4>
        <p><strong>File:</strong> <code>debezium/postgres-connector.json</code></p>
        <pre><code>{
  "name": "legacy-postgres-connector",
  "config": {
    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
    "database.hostname": "postgres",
    "database.port": "5432",
    "database.user": "postgres",
    "database.password": "postgres",
    "database.dbname": "legacy_db",
    "database.server.name": "legacy",
    "plugin.name": "pgoutput",
    "table.include.list": "public.legacy_users,public.legacy_posts,public.legacy_likes",
    "transforms": "unwrap",
    "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
    "snapshot.mode": "initial"
  }
}</code></pre>

        <h4>MySQL Connector:</h4>
        <p><strong>File:</strong> <code>debezium/mysql-connector.json</code></p>
        <pre><code>{
  "name": "revamp-mysql-connector",
  "config": {
    "connector.class": "io.debezium.connector.mysql.MySqlConnector",
    "database.hostname": "mysql",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "dbz",
    "database.server.name": "revamp",
    "table.include.list": "revamp_db.revamp_users,revamp_db.revamp_posts,revamp_db.revamp_likes",
    "schema.history.internal.kafka.bootstrap.servers": "kafka:9092",
    "schema.history.internal.kafka.topic": "schema-changes.revamp",
    "transforms": "unwrap",
    "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
    "snapshot.mode": "initial"
  }
}</code></pre>

        <div class="warning">
            <strong>âš ï¸ MySQL Permissions Required:</strong>
            <pre><code>GRANT RELOAD, FLUSH_TABLES, LOCK TABLES, REPLICATION SLAVE, REPLICATION CLIENT 
ON *.* TO 'debezium'@'%';
FLUSH PRIVILEGES;</code></pre>
        </div>

        <h3>6.3 Database Schema Requirements</h3>

        <h4>Critical Column: <code>source</code></h4>
        <p>Every table MUST have a <code>source</code> column (or equivalent flag) for loop prevention:</p>

        <p><strong>PostgreSQL:</strong></p>
        <pre><code>CREATE TABLE legacy_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(100),
    phone_number VARCHAR(20),
    status VARCHAR(20) DEFAULT 'active',
    source VARCHAR(20) DEFAULT 'legacy',  -- â† For loop prevention + data provenance
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);</code></pre>

        <p><strong>MySQL:</strong></p>
        <pre><code>CREATE TABLE revamp_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_name VARCHAR(50) UNIQUE NOT NULL,
    email_address VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(100),
    mobile VARCHAR(20),
    account_status VARCHAR(20) DEFAULT 'Active',
    source VARCHAR(20) DEFAULT 'revamp',  -- â† For loop prevention + data provenance
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;</code></pre>

        <h4>Source Column Approaches</h4>
        <p>There are multiple valid approaches for implementing loop prevention:</p>

        <div class="component-box">
            <h4>Approach 1: Three-Value System (Current Implementation) âœ… Recommended</h4>
            <p><strong>Values:</strong></p>
            <ul>
                <li><code>'legacy'</code> or <code>'postgres'</code> - Original PostgreSQL record</li>
                <li><code>'revamp'</code> or <code>'mysql'</code> - Original MySQL record</li>
                <li><code>'sync_service'</code> or <code>'synced'</code> - Synced record (skip processing)</li>
            </ul>
            <p><strong>Advantages:</strong></p>
            <ul>
                <li>âœ… Full data provenance tracking (know where data originated)</li>
                <li>âœ… Better auditing and troubleshooting</li>
                <li>âœ… Can query by origin platform</li>
                <li>âœ… Useful for analytics and debugging</li>
            </ul>
            <p><strong>Loop Prevention Logic:</strong></p>
            <pre><code>// In SyncEvent::shouldSkip()
public function shouldSkip(): bool
{
    return $this->source === 'sync_service';
}</code></pre>
        </div>

        <div class="component-box">
            <h4>Approach 2: Two-Value System</h4>
            <p><strong>Values:</strong></p>
            <ul>
                <li><code>NULL</code> or <code>'original'</code> - Native record (process it)</li>
                <li><code>'synced'</code> or <code>'sync_service'</code> - Synced record (skip it)</li>
            </ul>
            <p><strong>Schema:</strong></p>
            <pre><code>-- PostgreSQL
source VARCHAR(20) DEFAULT NULL

-- MySQL
source VARCHAR(20) DEFAULT NULL</code></pre>
            <p><strong>Advantages:</strong></p>
            <ul>
                <li>âœ… Simpler (only 2 states)</li>
                <li>âœ… Clear intent (synced vs not synced)</li>
                <li>âœ… Works perfectly for loop prevention</li>
            </ul>
            <p><strong>Disadvantages:</strong></p>
            <ul>
                <li>âŒ Lost data provenance (can't tell origin platform)</li>
                <li>âŒ Harder to debug sync issues</li>
            </ul>
            <p><strong>Loop Prevention Logic:</strong></p>
            <pre><code>public function shouldSkip(): bool
{
    return $this->source === 'synced';
    // NULL or any other value = process it
}</code></pre>
        </div>

        <div class="component-box">
            <h4>Approach 3: Boolean Flag</h4>
            <p><strong>Schema:</strong></p>
            <pre><code>-- PostgreSQL
is_synced BOOLEAN DEFAULT FALSE

-- MySQL
is_synced TINYINT(1) DEFAULT 0</code></pre>
            <p><strong>Advantages:</strong></p>
            <ul>
                <li>âœ… Simplest possible approach</li>
                <li>âœ… Most storage-efficient</li>
                <li>âœ… Clear true/false semantics</li>
            </ul>
            <p><strong>Disadvantages:</strong></p>
            <ul>
                <li>âŒ Lost data provenance</li>
                <li>âŒ Less descriptive than string values</li>
                <li>âŒ Requires code changes in DTOs</li>
            </ul>
            <p><strong>Loop Prevention Logic:</strong></p>
            <pre><code>public function shouldSkip(): bool
{
    return $this->payload['is_synced'] ?? false;
}</code></pre>
        </div>

        <table>
            <tr>
                <th>Approach</th>
                <th>Loop Prevention</th>
                <th>Data Provenance</th>
                <th>Complexity</th>
                <th>Recommendation</th>
            </tr>
            <tr>
                <td><strong>3 Values</strong></td>
                <td>âœ… Yes</td>
                <td>âœ… Yes</td>
                <td>Low</td>
                <td><span class="badge badge-success">Recommended</span></td>
            </tr>
            <tr>
                <td><strong>2 Values</strong></td>
                <td>âœ… Yes</td>
                <td>âŒ No</td>
                <td>Low</td>
                <td><span class="badge badge-info">Alternative</span></td>
            </tr>
            <tr>
                <td><strong>Boolean</strong></td>
                <td>âœ… Yes</td>
                <td>âŒ No</td>
                <td>Medium (code changes)</td>
                <td><span class="badge badge-warning">Simplest</span></td>
            </tr>
        </table>

        <div class="success">
            <strong>ğŸ’¡ Recommendation:</strong> Use the <strong>three-value approach</strong> (<code>legacy</code>, <code>revamp</code>, <code>sync_service</code>) 
            because it provides data provenance tracking with minimal overhead. You'll thank yourself later when debugging sync issues or analyzing data flow.
        </div>

        <h4>Decision Tree: Which Approach Should I Use?</h4>
        <div class="flow-diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Do you need to track WHERE each record originated from?        â”‚
â”‚  (e.g., "Show me all users from legacy system")                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
     â”‚               â”‚
    YES             NO
     â”‚               â”‚
     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                       â”‚
     â–¼                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Use 3-VALUE SYSTEM             â”‚    â”‚  Do you prefer string values     â”‚
â”‚                                 â”‚    â”‚  or boolean flags?               â”‚
â”‚  - source='postgres'            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  - source='mysql'               â”‚             â”‚
â”‚  - source='sync_service'        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚     â”‚                â”‚
â”‚  âœ… Data provenance             â”‚   STRING          BOOLEAN
â”‚  âœ… Better debugging            â”‚     â”‚                â”‚
â”‚  âœ… Audit trail                 â”‚     â–¼                â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚2-VALUE â”‚    â”‚ BOOLEAN  â”‚
                                     â”‚SYSTEM  â”‚    â”‚ FLAG     â”‚
                                     â”‚        â”‚    â”‚          â”‚
                                     â”‚NULL or â”‚    â”‚is_synced â”‚
                                     â”‚'synced'â”‚    â”‚TRUE/FALSEâ”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXAMPLES:

3-Value System (Recommended):
  PostgreSQL: source='postgres' (default)
  MySQL:      source='mysql' (default)
  Synced:     source='sync_service' (set by service)

2-Value System:
  Original:   source=NULL (default)
  Synced:     source='synced' (set by service)

Boolean Flag (Simplest):
  Original:   is_synced=FALSE (default)
  Synced:     is_synced=TRUE (set by service)
        </div>

        <!-- SECTION 7: PRODUCTION DEPLOYMENT -->
        <h2 id="production">7. Production Deployment</h2>

        <h3>7.1 Connecting to Actual Databases</h3>

        <div class="danger">
            <strong>ğŸš¨ Critical Steps for Production:</strong>
        </div>

        <h4>Step 1: Update Database Connections</h4>
        <p>Modify <code>sync-service/.env</code> with your actual database credentials:</p>
        <pre><code># Production PostgreSQL
DB_LEGACY_HOST=your-postgres-host.com
DB_LEGACY_PORT=5432
DB_LEGACY_DATABASE=your_actual_legacy_db
DB_LEGACY_USERNAME=your_postgres_user
DB_LEGACY_PASSWORD=your_secure_password

# Production MySQL
DB_REVAMP_HOST=your-mysql-host.com
DB_REVAMP_PORT=3306
DB_REVAMP_DATABASE=your_actual_revamp_db
DB_REVAMP_USERNAME=your_mysql_user
DB_REVAMP_PASSWORD=your_secure_password</code></pre>

        <h4>Step 2: Add <code>source</code> Column to Existing Tables</h4>
        <p>If your tables don't have the <code>source</code> column, add it. You can choose between different approaches:</p>

        <div class="info">
            <strong>Choose Your Approach:</strong>
            <ul>
                <li><strong>3-Value System</strong> (Recommended): Track origin platform + loop prevention</li>
                <li><strong>2-Value System</strong>: Simple loop prevention only</li>
                <li><strong>Boolean Flag</strong>: Simplest option</li>
            </ul>
        </div>

        <p><strong>Option 1: Three-Value System (Recommended)</strong></p>
        <p><strong>PostgreSQL:</strong></p>
        <pre><code>-- Add source column with default value
ALTER TABLE your_table_name 
ADD COLUMN source VARCHAR(20) DEFAULT 'postgres';  -- or 'legacy'

-- Backfill existing records (mark as original PostgreSQL records)
UPDATE your_table_name 
SET source = 'postgres' 
WHERE source IS NULL;</code></pre>

        <p><strong>MySQL:</strong></p>
        <pre><code>-- Add source column with default value
ALTER TABLE your_table_name 
ADD COLUMN source VARCHAR(20) DEFAULT 'mysql';  -- or 'revamp'

-- Backfill existing records (mark as original MySQL records)
UPDATE your_table_name 
SET source = 'mysql' 
WHERE source IS NULL;</code></pre>

        <p><strong>Option 2: Two-Value System</strong></p>
        <pre><code>-- PostgreSQL & MySQL
ALTER TABLE your_table_name 
ADD COLUMN source VARCHAR(20) DEFAULT NULL;

-- Existing records remain NULL (meaning: original, not synced)
-- Synced records will be marked as 'synced' by the sync service</code></pre>

        <p><strong>Option 3: Boolean Flag (Simplest)</strong></p>
        <pre><code>-- PostgreSQL
ALTER TABLE your_table_name 
ADD COLUMN is_synced BOOLEAN DEFAULT FALSE;

-- MySQL
ALTER TABLE your_table_name 
ADD COLUMN is_synced TINYINT(1) DEFAULT 0;

-- Existing records remain FALSE/0 (not synced)
-- Synced records will be marked as TRUE/1 by the sync service</code></pre>

        <div class="warning">
            <strong>âš ï¸ Important:</strong> Whichever approach you choose, you MUST update the following files:
            <ul>
                <li><code>app/DTOs/SyncEvent.php</code> - Update <code>shouldSkip()</code> method</li>
                <li><code>app/DTOs/UserDTO.php</code> (and other DTOs) - Update <code>toRevamp()</code> and <code>toLegacy()</code> methods</li>
                <li><code>app/Services/Writers/*</code> - Update write logic if using boolean flag</li>
            </ul>
        </div>

        <h4>Step 3: Update Debezium Connector Configurations</h4>

        <p><strong>PostgreSQL Connector:</strong></p>
        <p>Update <code>debezium/postgres-connector.json</code>:</p>
        <pre><code>{
  "name": "production-postgres-connector",
  "config": {
    "database.hostname": "your-postgres-host.com",
    "database.port": "5432",
    "database.user": "debezium_user",
    "database.password": "secure_password",
    "database.dbname": "your_actual_legacy_db",
    "table.include.list": "public.users,public.orders,public.products",
    // ... rest of config
  }
}</code></pre>

        <p><strong>MySQL Connector:</strong></p>
        <p>Update <code>debezium/mysql-connector.json</code>:</p>
        <pre><code>{
  "name": "production-mysql-connector",
  "config": {
    "database.hostname": "your-mysql-host.com",
    "database.port": "3306",
    "database.user": "debezium_user",
    "database.password": "secure_password",
    "table.include.list": "your_db.users,your_db.orders,your_db.products",
    // ... rest of config
  }
}</code></pre>

        <h4>Step 4: Create Schema Transformers for Your Tables</h4>
        <p>For each entity type, create DTO and update transformers:</p>

        <p><strong>Example: OrderDTO</strong></p>
        <pre><code>// app/DTOs/OrderDTO.php
class OrderDTO
{
    public function __construct(
        public readonly int $id,
        public readonly int $userId,
        public readonly float $total,
        public readonly string $status,
        // ... your fields
    ) {}

    public static function fromLegacy(array $data): self
    {
        return new self(
            id: $data['id'],
            userId: $data['user_id'],
            total: $data['order_total'],
            status: $data['order_status'],
            // ... map your fields
        );
    }

    public function toRevamp(): array
    {
        return [
            'id' => $this->id,
            'customer_id' => $this->userId,  // Different field name
            'amount' => $this->total,         // Different field name
            'status' => $this->status,
            'source' => 'sync_service',
        ];
    }
}</code></pre>

        <h4>Step 5: Update Transformer Factory</h4>
        <p>Register your new entities in <code>app/Services/Transformers/TransformerFactory.php</code>:</p>
        <pre><code>public static function createMapper(string $direction, string $entityType): TransformerInterface
{
    return match($entityType) {
        'users' => $direction === 'legacy_to_revamp' 
            ? new LegacyToRevampMapper() 
            : new RevampToLegacyMapper(),
        'orders' => $direction === 'legacy_to_revamp'
            ? new OrderLegacyToRevampMapper()
            : new OrderRevampToLegacyMapper(),
        // ... add your entities
        default => throw new \InvalidArgumentException("Unsupported entity: {$entityType}"),
    };
}</code></pre>

        <h4>Step 6: Update Kafka Topic Configuration</h4>
        <p>Update <code>sync-service/.env</code> with your actual table names:</p>
        <pre><code># Legacy Topics (adjust to your actual table names)
KAFKA_LEGACY_TOPIC=legacy.public.users,legacy.public.orders,legacy.public.products

# Revamp Topics (adjust to your actual table names)
KAFKA_REVAMP_TOPIC=revamp.your_db.users,revamp.your_db.orders,revamp.your_db.products</code></pre>

        <h3>7.2 Production Infrastructure</h3>

        <h4>Kafka & Debezium Deployment</h4>
        <div class="warning">
            <strong>âš ï¸ Do NOT use Docker Compose in production!</strong>
            <p>Deploy Kafka and Debezium on dedicated servers/clusters:</p>
            <ul>
                <li><strong>Kafka:</strong> Use Confluent Platform, AWS MSK, or self-hosted Kafka cluster (3+ brokers)</li>
                <li><strong>Zookeeper:</strong> 3+ node ensemble</li>
                <li><strong>Debezium:</strong> Kafka Connect cluster (2+ workers for HA)</li>
            </ul>
        </div>

        <h4>Laravel Sync Service Deployment</h4>
        <p><strong>Option 1: Supervisor (Recommended)</strong></p>
        <pre><code>; /etc/supervisor/conf.d/sync-consumers.conf

[program:sync-legacy-consumer]
command=php /path/to/sync-service/artisan consume:legacy-events
directory=/path/to/sync-service
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/sync-legacy-consumer.log
numprocs=1

[program:sync-revamp-consumer]
command=php /path/to/sync-service/artisan consume:revamp-events
directory=/path/to/sync-service
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/sync-revamp-consumer.log
numprocs=1</code></pre>

        <p><strong>Start with Supervisor:</strong></p>
        <pre><code>sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start sync-legacy-consumer sync-revamp-consumer
sudo supervisorctl status</code></pre>

        <p><strong>Option 2: systemd</strong></p>
        <pre><code># /etc/systemd/system/sync-legacy-consumer.service

[Unit]
Description=Sync Legacy Event Consumer
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/sync-service
ExecStart=/usr/bin/php /path/to/sync-service/artisan consume:legacy-events
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target</code></pre>

        <p><strong>Start with systemd:</strong></p>
        <pre><code>sudo systemctl enable sync-legacy-consumer
sudo systemctl start sync-legacy-consumer
sudo systemctl status sync-legacy-consumer</code></pre>

        <h3>7.3 Scaling Considerations</h3>

        <h4>Horizontal Scaling</h4>
        <p>You can run multiple consumer instances for high throughput:</p>
        <ul>
            <li>All consumers with the <strong>same consumer group ID</strong> will automatically partition work</li>
            <li>If you have 3 topics and 3 consumer instances, each will handle 1 topic</li>
            <li><strong>Max instances = number of topic partitions</strong></li>
        </ul>

        <p><strong>Example: 3 Consumer Instances</strong></p>
        <pre><code># Supervisor config with multiple processes
[program:sync-legacy-consumer]
command=php /path/to/sync-service/artisan consume:legacy-events
numprocs=3  # â† Run 3 instances
process_name=%(program_name)s_%(process_num)02d</code></pre>

        <h4>Performance Tuning</h4>
        <p>Adjust in <code>sync-service/.env</code>:</p>
        <pre><code># Increase batch size for high-volume scenarios
KAFKA_MAX_POLL_RECORDS=500

# Reduce for low-latency scenarios
KAFKA_MAX_POLL_RECORDS=10

# Session timeout (how long before consumer is considered dead)
KAFKA_SESSION_TIMEOUT_MS=30000</code></pre>

        <h3>7.4 Database User Permissions</h3>

        <h4>PostgreSQL User for Debezium:</h4>
        <pre><code>-- Create dedicated user
CREATE USER debezium_user WITH PASSWORD 'secure_password';

-- Grant replication permissions
ALTER USER debezium_user REPLICATION;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO debezium_user;
GRANT USAGE ON SCHEMA public TO debezium_user;

-- Enable logical replication
ALTER SYSTEM SET wal_level = 'logical';
-- Restart PostgreSQL after this change</code></pre>

        <h4>MySQL User for Debezium:</h4>
        <pre><code>-- Create dedicated user
CREATE USER 'debezium_user'@'%' IDENTIFIED BY 'secure_password';

-- Grant necessary permissions
GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT 
ON *.* TO 'debezium_user'@'%';

GRANT FLUSH_TABLES, LOCK TABLES 
ON *.* TO 'debezium_user'@'%';

FLUSH PRIVILEGES;

-- Enable binlog (in my.cnf)
-- server-id = 1
-- log_bin = mysql-bin
-- binlog_format = ROW
-- binlog_row_image = FULL</code></pre>

        <h4>Laravel Sync Service Database User:</h4>
        <p>Needs read/write permissions on both databases:</p>
        <pre><code>-- PostgreSQL
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO sync_service_user;

-- MySQL
GRANT SELECT, INSERT, UPDATE, DELETE ON your_database.* TO 'sync_service_user'@'%';</code></pre>

        <!-- SECTION 8: MONITORING -->
        <h2 id="monitoring">8. Monitoring & Troubleshooting</h2>

        <h3>8.1 Connector Management Commands</h3>
        
        <div class="info">
            <strong>ğŸ’¡ Important Note:</strong> Debezium connectors do NOT persist across container restarts. 
            After restarting <code>docker-compose</code> or the Debezium container, you must re-register the connectors.
        </div>

        <h4>Register Connectors (Required After Restart):</h4>
        <p>Use these commands to register both connectors with Debezium:</p>
        <pre><code># PostgreSQL Connector
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/postgres-connector.json" http://localhost:8083/connectors

# MySQL Connector
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/mysql-connector.json" http://localhost:8083/connectors</code></pre>

        <div class="warning">
            <strong>âš ï¸ Troubleshooting:</strong> If you get "Empty reply from server", wait 30-60 seconds after starting Docker Compose for Debezium to fully initialize.
        </div>

        <h4>List All Registered Connectors:</h4>
        <pre><code>curl.exe http://localhost:8083/connectors</code></pre>
        
        <p><strong>Expected Output:</strong></p>
        <pre><code>["revamp-mysql-connector","legacy-postgres-connector"]</code></pre>

        <h4>Check Connector Status:</h4>
        <pre><code># PostgreSQL Connector Status
curl.exe http://localhost:8083/connectors/legacy-postgres-connector/status

# MySQL Connector Status
curl.exe http://localhost:8083/connectors/revamp-mysql-connector/status</code></pre>

        <h3>8.2 Health Checks</h3>

        <h4>Verify Connector Health:</h4>
        <pre><code># List all connectors (general endpoint)
curl http://your-kafka-connect-host:8083/connectors/

# Check specific connector status (production)
curl http://your-kafka-connect-host:8083/connectors/legacy-postgres-connector/status
curl http://your-kafka-connect-host:8083/connectors/revamp-mysql-connector/status</code></pre>

        <p><strong>Healthy Response:</strong></p>
        <pre><code>{
  "name": "legacy-postgres-connector",
  "connector": {"state": "RUNNING"},
  "tasks": [{"id": 0, "state": "RUNNING"}]
}</code></pre>

        <div class="success">
            <strong>âœ… Healthy Status Indicators:</strong>
            <ul>
                <li><code>connector.state</code> = <code>"RUNNING"</code></li>
                <li><code>tasks[0].state</code> = <code>"RUNNING"</code></li>
                <li>No error messages in response</li>
            </ul>
        </div>

        <h4>Check Consumer Lag:</h4>
        <pre><code>docker exec kafka kafka-consumer-groups \
  --bootstrap-server localhost:9092 \
  --group sync-service-legacy \
  --describe</code></pre>

        <p><strong>Output:</strong></p>
        <pre><code>GROUP               TOPIC                      PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG
sync-service-legacy legacy.public.legacy_users 0          1523            1523            0
                                                                                            â†‘
                                                                                  Lag should be 0 or low</code></pre>

        <h3>8.3 Quick Start Commands Reference</h3>
        
        <div class="component-box">
            <h4>Complete Startup Sequence</h4>
            <p>After running <code>docker-compose up -d</code>, follow these steps:</p>
            
            <p><strong>Step 1: Wait for Debezium to Start</strong></p>
            <pre><code># Wait 30-60 seconds, then verify Debezium is ready
curl.exe http://localhost:8083/connectors

# Should return: []</code></pre>

            <p><strong>Step 2: Register Connectors</strong></p>
            <pre><code># Register PostgreSQL connector
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/postgres-connector.json" http://localhost:8083/connectors

# Register MySQL connector
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/mysql-connector.json" http://localhost:8083/connectors</code></pre>

            <p><strong>Step 3: Verify Connectors are Running</strong></p>
            <pre><code># List connectors
curl.exe http://localhost:8083/connectors
# Should return: ["revamp-mysql-connector","legacy-postgres-connector"]

# Check PostgreSQL connector
curl.exe http://localhost:8083/connectors/legacy-postgres-connector/status
# Should show: "state": "RUNNING"

# Check MySQL connector
curl.exe http://localhost:8083/connectors/revamp-mysql-connector/status
# Should show: "state": "RUNNING"</code></pre>

            <p><strong>Step 4: Start Laravel Consumers</strong></p>
            <pre><code># Terminal 1: PostgreSQL -> MySQL consumer
cd sync-service
php artisan consume:legacy-events

# Terminal 2: MySQL -> PostgreSQL consumer
cd sync-service
php artisan consume:revamp-events</code></pre>

            <p><strong>Step 5: Test Sync</strong></p>
            <pre><code># Use the test batch script
test-sync.bat

# Or manual test (PostgreSQL -> MySQL)
docker exec sync-postgres psql -U postgres -d legacy_db -c "INSERT INTO legacy_users (username, email, full_name, source) VALUES ('testuser', 'test@example.com', 'Test User', 'legacy');"

# Wait 5 seconds
Start-Sleep -Seconds 5

# Verify sync
docker exec sync-mysql mysql -uroot -proot revamp_db -e "SELECT * FROM revamp_users WHERE user_name = 'testuser';"</code></pre>
        </div>

        <div class="component-box">
            <h4>Alternative: Use Batch Script (Windows)</h4>
            <p>We provide a convenient batch script for connector registration:</p>
            <pre><code># Register both connectors automatically
.\register-connectors.bat

# Check connector status
.\check-connectors.bat</code></pre>
        </div>

        <h3>8.4 Logging & Observability</h3>

        <h4>Laravel Logs:</h4>
        <p><strong>Location:</strong> <code>sync-service/storage/logs/laravel.log</code></p>
        <p><strong>Log Levels:</strong></p>
        <ul>
            <li><code>INFO</code>: Successful event processing</li>
            <li><code>WARNING</code>: Retry attempts</li>
            <li><code>ERROR</code>: Failed operations, sent to DLQ</li>
        </ul>

        <p><strong>Key Log Messages:</strong></p>
        <pre><code># Successful processing
[INFO] Processing event [uuid] CREATE users/123 (source: legacy)
[INFO] Event processed successfully

# Loop prevention
[INFO] Skipping event (loop prevention) [uuid] (source: sync_service)

# Retry
[WARNING] Attempt failed [uuid] (attempt 2/3)

# Failure
[ERROR] All retry attempts failed [uuid]
[ERROR] Sent event to DLQ</code></pre>

        <h4>Dead Letter Queue (DLQ):</h4>
        <p>Failed events are sent to <code>sync.dlq</code> topic for manual investigation:</p>
        <pre><code># View DLQ messages
docker exec kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic sync.dlq \
  --from-beginning</code></pre>

        <h3>8.5 Common Issues & Solutions</h3>

        <div class="component-box">
            <h4>Issue: Consumer Lag Increasing</h4>
            <p><strong>Symptoms:</strong> <code>LAG</code> value increasing over time</p>
            <p><strong>Causes:</strong></p>
            <ul>
                <li>Consumer processing too slow</li>
                <li>Database write operations are slow</li>
                <li>High event volume</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <ol>
                <li>Scale horizontally (add more consumer instances)</li>
                <li>Optimize database queries</li>
                <li>Increase <code>KAFKA_MAX_POLL_RECORDS</code> for batch processing</li>
                <li>Add database indexes on frequently queried columns</li>
            </ol>
        </div>

        <div class="component-box">
            <h4>Issue: Debezium Connector Stopped</h4>
            <p><strong>Symptoms:</strong> Connector status shows <code>FAILED</code></p>
            <p><strong>Causes:</strong></p>
            <ul>
                <li>Database connection lost</li>
                <li>Insufficient permissions</li>
                <li>Disk space full (schema history topic)</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <pre><code># Check connector logs
docker logs sync-connect | grep ERROR

# Restart connector
curl -X POST http://localhost:8083/connectors/legacy-postgres-connector/restart

# Delete and re-register if needed
curl -X DELETE http://localhost:8083/connectors/legacy-postgres-connector
curl -X POST -H "Content-Type: application/json" \
  --data @postgres-connector.json \
  http://localhost:8083/connectors/</code></pre>
        </div>

        <div class="component-box">
            <h4>Issue: Connector Not Found (404 Error)</h4>
            <p><strong>Symptoms:</strong> <code>{"error_code":404,"message":"Unknown connector: legacy-postgres-connector"}</code></p>
            <p><strong>Causes:</strong></p>
            <ul>
                <li>Debezium container was restarted</li>
                <li>Connectors were never registered</li>
                <li>Connectors were deleted</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <pre><code># Re-register the connectors
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/postgres-connector.json" http://localhost:8083/connectors
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/mysql-connector.json" http://localhost:8083/connectors

# Or use the batch script (Windows)
.\register-connectors.bat

# Verify registration
curl.exe http://localhost:8083/connectors</code></pre>
            <div class="warning">
                <strong>âš ï¸ Remember:</strong> Connectors do NOT persist across Debezium restarts. You must re-register them after every <code>docker-compose restart</code> or <code>docker-compose up</code>.
            </div>
        </div>

        <div class="component-box">
            <h4>Issue: Empty Reply from Server</h4>
            <p><strong>Symptoms:</strong> <code>curl: (52) Empty reply from server</code></p>
            <p><strong>Causes:</strong></p>
            <ul>
                <li>Debezium is still starting up</li>
                <li>Debezium container is not running</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <pre><code># Check if Debezium container is running
docker ps --filter "name=sync-connect"

# If not running, start it
docker-compose up -d

# Wait 30-60 seconds for Debezium to initialize
Start-Sleep -Seconds 30

# Try again
curl.exe http://localhost:8083/connectors</code></pre>
        </div>

        <div class="component-box">
            <h4>Issue: Duplicate Records</h4>
            <p><strong>Symptoms:</strong> Same record appears multiple times</p>
            <p><strong>Causes:</strong></p>
            <ul>
                <li>Consumer crashed before committing offset</li>
                <li>Network issues causing message replay</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <ul>
                <li>âœ… <strong>Already handled by UPSERT!</strong> The idempotent writers use UPSERT, so replaying events won't create duplicates.</li>
                <li>Verify <code>processed_events</code> table is being updated</li>
            </ul>
        </div>

        <div class="component-box">
            <h4>Issue: Infinite Loop Detected</h4>
            <p><strong>Symptoms:</strong> Same record keeps syncing back and forth</p>
            <p><strong>Causes:</strong></p>
            <ul>
                <li><code>source</code> column not set correctly</li>
                <li>Loop prevention logic bypassed</li>
            </ul>
            <p><strong>Solutions:</strong></p>
            <pre><code># Check if source is set correctly
SELECT id, username, source FROM legacy_users WHERE id = 123;
SELECT id, user_name, source FROM revamp_users WHERE id = 123;

# Verify loop prevention is working
grep "Skipping event (loop prevention)" storage/logs/laravel.log</code></pre>
        </div>

        <h3>8.6 Metrics to Monitor</h3>

        <table>
            <tr>
                <th>Metric</th>
                <th>Healthy Value</th>
                <th>Alert Threshold</th>
            </tr>
            <tr>
                <td>Consumer Lag</td>
                <td>< 100</td>
                <td>> 1000</td>
            </tr>
            <tr>
                <td>Events Processed/sec</td>
                <td>> 10</td>
                <td>< 1</td>
            </tr>
            <tr>
                <td>DLQ Message Count</td>
                <td>0</td>
                <td>> 10</td>
            </tr>
            <tr>
                <td>Connector Status</td>
                <td>RUNNING</td>
                <td>FAILED</td>
            </tr>
            <tr>
                <td>Consumer Memory Usage</td>
                <td>< 512MB</td>
                <td>> 1GB</td>
            </tr>
            <tr>
                <td>Processing Time (p99)</td>
                <td>< 100ms</td>
                <td>> 1000ms</td>
            </tr>
        </table>

        <h3>8.7 Rollback Strategy</h3>

        <div class="danger">
            <strong>ğŸš¨ Emergency Rollback Procedure</strong>
            <p>If sync causes issues in production:</p>
            <ol>
                <li><strong>Stop Consumers:</strong>
                    <pre><code>sudo supervisorctl stop sync-legacy-consumer sync-revamp-consumer</code></pre>
                </li>
                <li><strong>Pause Debezium Connectors:</strong>
                    <pre><code>curl -X PUT http://localhost:8083/connectors/legacy-postgres-connector/pause
curl -X PUT http://localhost:8083/connectors/revamp-mysql-connector/pause</code></pre>
                </li>
                <li><strong>Investigate Issues:</strong>
                    <ul>
                        <li>Check logs</li>
                        <li>Verify data consistency</li>
                        <li>Review DLQ messages</li>
                    </ul>
                </li>
                <li><strong>Resume When Fixed:</strong>
                    <pre><code>curl -X PUT http://localhost:8083/connectors/legacy-postgres-connector/resume
curl -X PUT http://localhost:8083/connectors/revamp-mysql-connector/resume
sudo supervisorctl start sync-legacy-consumer sync-revamp-consumer</code></pre>
                </li>
            </ol>
        </div>

        <h3>8.8 Frequently Asked Questions (FAQ)</h3>

        <div class="component-box">
            <h4>Q: Why do I get "Unknown connector" error after restarting Docker?</h4>
            <p><strong>A:</strong> <strong>Connectors don't persist across restarts!</strong></p>
            <p>Debezium stores connector configurations in memory and Kafka topics. When you restart the <code>sync-connect</code> container or run <code>docker-compose down</code>, you need to re-register the connectors.</p>
            <p><strong>Solution:</strong></p>
            <pre><code># After docker-compose up -d, wait 30 seconds, then:
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/postgres-connector.json" http://localhost:8083/connectors
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/mysql-connector.json" http://localhost:8083/connectors

# Or use the batch script
.\register-connectors.bat</code></pre>
            <p><strong>Pro Tip:</strong> Add connector registration to your startup script:</p>
            <pre><code>@echo off
docker-compose up -d
echo Waiting for Debezium...
timeout /t 30 /nobreak
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/postgres-connector.json" http://localhost:8083/connectors
curl.exe -X POST -H "Content-Type: application/json" --data "@debezium/mysql-connector.json" http://localhost:8083/connectors
echo Connectors registered!
cd sync-service
start cmd /k "php artisan consume:legacy-events"
start cmd /k "php artisan consume:revamp-events"</code></pre>
        </div>

        <div class="component-box">
            <h4>Q: How do I check if connectors are registered?</h4>
            <p><strong>A:</strong> Use the list and status commands.</p>
            <pre><code># List all registered connectors
curl.exe http://localhost:8083/connectors
# Returns: ["revamp-mysql-connector","legacy-postgres-connector"]

# Check specific connector status
curl.exe http://localhost:8083/connectors/legacy-postgres-connector/status
# Returns: {"name":"legacy-postgres-connector","connector":{"state":"RUNNING"},...}

curl.exe http://localhost:8083/connectors/revamp-mysql-connector/status
# Returns: {"name":"revamp-mysql-connector","connector":{"state":"RUNNING"},...}</code></pre>
            <p><strong>What to look for:</strong></p>
            <ul>
                <li>âœ… <code>connector.state</code> = <code>"RUNNING"</code></li>
                <li>âœ… <code>tasks[0].state</code> = <code>"RUNNING"</code></li>
                <li>âŒ <code>"FAILED"</code> or <code>"PAUSED"</code> means there's an issue</li>
            </ul>
        </div>

        <div class="component-box">
            <h4>Q: Do I need to set source='legacy' or source='revamp' on every record?</h4>
            <p><strong>A:</strong> <strong>No, not strictly required for loop prevention.</strong></p>
            <p>For loop prevention to work, you only need:</p>
            <ul>
                <li>âœ… <code>source='sync_service'</code> (or <code>'synced'</code>) on synced records</li>
                <li>âœ… Any other value (or NULL) on original records</li>
            </ul>
            <p><strong>Why use 3 values then?</strong> Data provenance tracking. It helps you:</p>
            <ul>
                <li>Know which platform a record originated from</li>
                <li>Debug sync issues ("did this come from PostgreSQL or MySQL?")</li>
                <li>Run analytics ("how many users came from the legacy system?")</li>
            </ul>
            <p><strong>Minimum Working Example:</strong></p>
            <pre><code>-- PostgreSQL: original records can be NULL
source VARCHAR(20) DEFAULT NULL

-- MySQL: original records can be NULL
source VARCHAR(20) DEFAULT NULL

-- Sync service always sets: source='sync_service'
-- Loop prevention checks: if source='sync_service', skip</code></pre>
        </div>

        <div class="component-box">
            <h4>Q: What happens if I forget to set the source column?</h4>
            <p><strong>A:</strong> <strong>Infinite loop!</strong> âš ï¸</p>
            <p>Without the source column:</p>
            <ol>
                <li>PostgreSQL record syncs to MySQL</li>
                <li>MySQL thinks it's a new record, syncs back to PostgreSQL</li>
                <li>PostgreSQL thinks it's an update, syncs to MySQL</li>
                <li>...infinite loop continues...</li>
            </ol>
            <p><strong>Prevention:</strong> The sync service ALWAYS sets <code>source='sync_service'</code> when writing. 
            Make sure this column exists and the consumer checks it!</p>
        </div>

        <div class="component-box">
            <h4>Q: Can I change the source column name or use a different mechanism?</h4>
            <p><strong>A:</strong> Yes! You can use any mechanism as long as it prevents loops.</p>
            <p><strong>Examples:</strong></p>
            <ul>
                <li><code>sync_origin</code> column instead of <code>source</code></li>
                <li><code>is_synced</code> boolean flag</li>
                <li><code>record_type</code> enum ('native', 'synced')</li>
            </ul>
            <p><strong>Required Code Changes:</strong></p>
            <ul>
                <li>Update <code>SyncEvent::shouldSkip()</code> to check your field</li>
                <li>Update DTOs to set your field when transforming</li>
                <li>Update Writers to include your field in UPSERT queries</li>
            </ul>
        </div>

        <div class="component-box">
            <h4>Q: How do I handle existing records when I add the source column?</h4>
            <p><strong>A:</strong> Set them to their native platform value or NULL.</p>
            <p><strong>Example:</strong></p>
            <pre><code>-- PostgreSQL: Mark existing records as 'postgres' or 'legacy'
ALTER TABLE users ADD COLUMN source VARCHAR(20) DEFAULT 'postgres';

-- MySQL: Mark existing records as 'mysql' or 'revamp'
ALTER TABLE users ADD COLUMN source VARCHAR(20) DEFAULT 'mysql';

-- Alternative: Leave as NULL (means "original, not synced")
ALTER TABLE users ADD COLUMN source VARCHAR(20) DEFAULT NULL;</code></pre>
            <p><strong>Why?</strong> When Debezium takes its initial snapshot, these existing records will be captured 
            as CDC events. The consumer needs to know they're original records (not synced), so it processes them.</p>
        </div>

        <div class="component-box">
            <h4>Q: What if the source column gets corrupted or set incorrectly?</h4>
            <p><strong>A:</strong> <strong>High risk of data inconsistency!</strong></p>
            <p><strong>Symptoms:</strong></p>
            <ul>
                <li>Records not syncing when they should</li>
                <li>Infinite loops starting</li>
                <li>Data drift between platforms</li>
            </ul>
            <p><strong>Fix:</strong></p>
            <pre><code>-- Find records with incorrect source
SELECT id, username, source FROM legacy_users WHERE source NOT IN ('legacy', 'postgres', 'sync_service', NULL);

-- Fix them
UPDATE legacy_users 
SET source = 'postgres' 
WHERE source NOT IN ('legacy', 'postgres', 'sync_service') OR source IS NULL;</code></pre>
            <p><strong>Prevention:</strong> Add a CHECK constraint:</p>
            <pre><code>-- PostgreSQL
ALTER TABLE legacy_users 
ADD CONSTRAINT check_source 
CHECK (source IN ('postgres', 'legacy', 'sync_service') OR source IS NULL);

-- MySQL
ALTER TABLE revamp_users 
ADD CONSTRAINT check_source 
CHECK (source IN ('mysql', 'revamp', 'sync_service') OR source IS NULL);</code></pre>
        </div>

        <div class="component-box">
            <h4>Q: Can I sync across more than 2 databases?</h4>
            <p><strong>A:</strong> Yes, but complexity increases significantly.</p>
            <p><strong>Example: 3-way sync (PostgreSQL â†” MySQL â†” MongoDB)</strong></p>
            <p>You'd need:</p>
            <ul>
                <li>3 Debezium connectors (one per database)</li>
                <li>6 consumer flows (each database to the other 2)</li>
                <li>Enhanced loop prevention (track which databases have already received the record)</li>
            </ul>
            <p><strong>Recommendation:</strong> Use a "hub and spoke" model instead:</p>
            <ul>
                <li><strong>Hub:</strong> One "source of truth" database</li>
                <li><strong>Spokes:</strong> All other databases sync to/from the hub</li>
                <li>Reduces complexity from NÃ—(N-1) connections to just 2Ã—N connections</li>
            </ul>
        </div>

        <div class="component-box">
            <h4>Q: What's the performance impact of the source column?</h4>
            <p><strong>A:</strong> Minimal to negligible.</p>
            <table>
                <tr>
                    <th>Aspect</th>
                    <th>Impact</th>
                </tr>
                <tr>
                    <td>Storage</td>
                    <td>~20 bytes per record (VARCHAR(20))</td>
                </tr>
                <tr>
                    <td>Index Size</td>
                    <td>~40-50 bytes per record if indexed</td>
                </tr>
                <tr>
                    <td>Query Performance</td>
                    <td>No impact (not typically used in WHERE clauses by app)</td>
                </tr>
                <tr>
                    <td>Insert Performance</td>
                    <td>&lt;1% overhead (one extra column)</td>
                </tr>
            </table>
            <p><strong>Optimization:</strong> If storage is critical, use a TINYINT/SMALLINT enum:</p>
            <pre><code>-- PostgreSQL
source SMALLINT DEFAULT 1  -- 1=native, 2=synced (2 bytes)

-- MySQL
source TINYINT DEFAULT 1   -- 1=native, 2=synced (1 byte)</code></pre>
        </div>

        <hr style="margin: 40px 0;">

        <div class="success">
            <h3>âœ… System Successfully Implemented</h3>
            <p>This POC demonstrates a production-ready two-way database synchronization system with:</p>
            <ul>
                <li>âœ… Real-time CDC using Debezium</li>
                <li>âœ… Event-driven architecture with Kafka</li>
                <li>âœ… Intelligent loop prevention</li>
                <li>âœ… Schema transformation</li>
                <li>âœ… Idempotent operations</li>
                <li>âœ… Fault tolerance and error handling</li>
                <li>âœ… Production deployment guidelines</li>
            </ul>
        </div>

        <div class="info">
            <h4>ğŸ“ Next Steps for Developers:</h4>
            <ol>
                <li>Review this documentation thoroughly</li>
                <li>Test the POC in a staging environment</li>
                <li>Create DTOs and Transformers for your actual entities</li>
                <li>Update database connection strings</li>
                <li>Add <code>source</code> column to existing tables</li>
                <li>Deploy Kafka and Debezium to production infrastructure</li>
                <li>Set up monitoring and alerting</li>
                <li>Test with production-like data volume</li>
                <li>Prepare rollback procedures</li>
                <li>Go live! ğŸš€</li>
            </ol>
        </div>

        <p style="text-align: center; margin-top: 40px; color: #777;">
            <strong>Document Version:</strong> 1.0.0<br>
            <strong>Last Updated:</strong> January 2026<br>
            <strong>Status:</strong> <span class="badge badge-success">Production Ready</span>
        </p>

    </div>
</body>
</html>

